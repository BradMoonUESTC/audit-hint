import * as vscode from 'vscode';
import { RagService } from './ragService';

export class VulnerabilityPanel {
    public static readonly viewType = 'vulnerabilityPanel';
    private readonly _panel: vscode.WebviewPanel;
    private _disposables: vscode.Disposable[] = [];
    private _ragService: RagService;
    private _isAnalyzing: boolean = false;

    public static createOrShow(extensionUri: vscode.Uri, ragService: RagService): VulnerabilityPanel {
        const column = vscode.window.activeTextEditor
            ? vscode.window.activeTextEditor.viewColumn
            : undefined;

        // 如果已经有面板，则显示它
        if (VulnerabilityPanel.currentPanel) {
            VulnerabilityPanel.currentPanel._panel.reveal(column);
            return VulnerabilityPanel.currentPanel;
        }

        // 否则，创建一个新面板
        const panel = vscode.window.createWebviewPanel(
            VulnerabilityPanel.viewType,
            '代码审计提示助手',
            column || vscode.ViewColumn.One,
            {
                enableScripts: true,
                retainContextWhenHidden: true,
                localResourceRoots: [vscode.Uri.joinPath(extensionUri, 'media')]
            }
        );

        return new VulnerabilityPanel(extensionUri, ragService, panel);
    }

    private static currentPanel: VulnerabilityPanel | undefined;

    constructor(
        private readonly _extensionUri: vscode.Uri,
        ragService: RagService,
        panel?: vscode.WebviewPanel
    ) {
        this._ragService = ragService;

        if (panel) {
            this._panel = panel;
        } else {
            this._panel = vscode.window.createWebviewPanel(
                VulnerabilityPanel.viewType,
                '代码审计提示助手',
                vscode.ViewColumn.One,
                {
                    enableScripts: true,
                    retainContextWhenHidden: true,
                    localResourceRoots: [vscode.Uri.joinPath(_extensionUri, 'media')]
                }
            );
        }

        // 设置HTML内容
        this._panel.webview.html = this._getWebviewContent();

        // 处理来自WebView的消息
        this._panel.webview.onDidReceiveMessage(
            async (message) => {
                switch (message.command) {
                    case 'analyze':
                        if (this._isAnalyzing) {
                            this._panel.webview.postMessage({ 
                                command: 'showMessage', 
                                message: '分析正在进行中，请稍候...' 
                            });
                            return;
                        }
                        
                        await this.analyzeCode(message.code, message.language);
                        break;
                    case 'toggleExampleMode':
                        this._ragService.toggleExampleMode(message.useExample);
                        this._panel.webview.postMessage({ 
                            command: 'showMessage', 
                            message: `已切换到${message.useExample ? '示例' : '实际'}漏洞模式` 
                        });
                        break;
                    case 'openConfig':
                        vscode.commands.executeCommand('vulnerability-detector.openConfiguration');
                        break;
                }
            },
            null,
            this._disposables
        );

        // 当面板关闭时清理资源
        this._panel.onDidDispose(() => this.dispose(), null, this._disposables);

        // 更新当前面板引用
        VulnerabilityPanel.currentPanel = this;
    }

    public async analyzeCode(code: string, language: string): Promise<void> {
        if (this._isAnalyzing) {
            return;
        }

        this._isAnalyzing = true;
        this._panel.webview.postMessage({ command: 'startAnalysis' });

        try {
            // 调用RAG服务分析代码
            const results = await this._ragService.queryVulnerabilities(code, language);
            
            // 发送结果到WebView
            this._panel.webview.postMessage({
                command: 'analysisResult',
                results: results
            });
            
            // 如果不是示例模式且有结果，则启动翻译
            if (!this._ragService.getExampleMode() && results.length > 0) {
                // 获取要翻译的漏洞信息
                let vulnerabilitiesToTranslate;
                
                if (results[0].auditPoints && results[0].originalVulnerabilities) {
                    // 如果是增强后的结果，使用附加的原始漏洞信息
                    vulnerabilitiesToTranslate = results[0].originalVulnerabilities;
                } else {
                    // 否则使用结果本身
                    vulnerabilitiesToTranslate = results;
                }
                
                // 异步翻译漏洞信息
                this._ragService.translateVulnerabilityInfo(vulnerabilitiesToTranslate).then(translatedText => {
                    this._panel.webview.postMessage({
                        command: 'translationResult',
                        translatedText: translatedText
                    });
                }).catch(error => {
                    console.error('翻译过程出错:', error);
                    this._panel.webview.postMessage({
                        command: 'translationResult',
                        translatedText: '翻译失败: ' + error
                    });
                });
            }
        } catch (error) {
            console.error('分析代码时出错:', error);
            this._panel.webview.postMessage({
                command: 'analysisError',
                error: `分析失败: ${error}`
            });
        } finally {
            this._isAnalyzing = false;
        }
    }

    public reveal(): void {
        this._panel.reveal(vscode.ViewColumn.One);
    }

    public dispose(): void {
        VulnerabilityPanel.currentPanel = undefined;

        // 清理资源
        this._panel.dispose();

        while (this._disposables.length) {
            const disposable = this._disposables.pop();
            if (disposable) {
                disposable.dispose();
            }
        }
    }

    public onDidDispose(callback: () => void): vscode.Disposable {
        return this._panel.onDidDispose(callback);
    }

    private _getWebviewContent(): string {
        const isExampleMode = this._ragService.getExampleMode();
        
        return `<!DOCTYPE html>
        <html lang="zh-CN">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>代码漏洞分析</title>
            <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
            <style>
                body {
                    font-family: var(--vscode-font-family);
                    padding: 20px;
                    color: var(--vscode-foreground);
                    background-color: var(--vscode-editor-background);
                }
                .container {
                    display: flex;
                    flex-direction: column;
                    height: 100vh;
                }
                .input-section {
                    margin-bottom: 20px;
                }
                textarea {
                    width: 100%;
                    height: 200px;
                    background-color: var(--vscode-input-background);
                    color: var(--vscode-input-foreground);
                    border: 1px solid var(--vscode-input-border);
                    padding: 8px;
                    font-family: 'Courier New', monospace;
                    resize: vertical;
                }
                .controls {
                    display: flex;
                    justify-content: space-between;
                    margin: 10px 0;
                }
                button {
                    background-color: var(--vscode-button-background);
                    color: var(--vscode-button-foreground);
                    border: none;
                    padding: 8px 16px;
                    cursor: pointer;
                }
                button:hover {
                    background-color: var(--vscode-button-hoverBackground);
                }
                button:disabled {
                    opacity: 0.5;
                    cursor: not-allowed;
                }
                .mode-toggle {
                    display: flex;
                    align-items: center;
                }
                .output-container {
                    display: flex;
                    flex-direction: column;
                    flex: 1;
                    overflow: hidden;
                }
                .output-tabs {
                    display: flex;
                    border-bottom: 1px solid var(--vscode-panel-border);
                }
                .tab {
                    padding: 8px 16px;
                    cursor: pointer;
                    border: 1px solid transparent;
                    border-bottom: none;
                }
                .tab.active {
                    background-color: var(--vscode-tab-activeBackground);
                    border-color: var(--vscode-panel-border);
                    border-bottom-color: transparent;
                }
                .output-section {
                    flex: 1;
                    overflow: auto;
                    border: 1px solid var(--vscode-panel-border);
                    border-top: none;
                    padding: 10px;
                    background-color: var(--vscode-editor-background);
                    display: none;
                }
                .output-section.active {
                    display: block;
                }
                .output-content {
                    white-space: pre-wrap;
                    font-family: 'Courier New', monospace;
                }
                .loading {
                    text-align: center;
                    padding: 20px;
                    display: none;
                }
                .spinner {
                    border: 4px solid rgba(0, 0, 0, 0.1);
                    border-radius: 50%;
                    border-top: 4px solid var(--vscode-progressBar-background);
                    width: 40px;
                    height: 40px;
                    animation: spin 1s linear infinite;
                    margin: 0 auto 10px;
                }
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
                .message {
                    margin: 10px 0;
                    padding: 8px;
                    background-color: var(--vscode-inputValidation-infoBackground);
                    border: 1px solid var(--vscode-inputValidation-infoBorder);
                    color: var(--vscode-inputValidation-infoForeground);
                    display: none;
                }
                .vulnerability-item {
                    margin-bottom: 20px;
                    padding: 10px;
                    border: 1px solid var(--vscode-panel-border);
                    background-color: var(--vscode-editor-background);
                }
                .vulnerability-title {
                    font-weight: bold;
                    margin-bottom: 5px;
                }
                .severity-high {
                    color: #ff5252;
                }
                .severity-medium {
                    color: #ffab40;
                }
                .severity-low {
                    color: #66bb6a;
                }
                .audit-points {
                    margin-top: 10px;
                    white-space: pre-wrap;
                }
                .translation-content {
                    white-space: pre-wrap;
                    font-family: var(--vscode-font-family);
                }
                .markdown-content h1, .markdown-content h2, .markdown-content h3 {
                    margin-top: 16px;
                    margin-bottom: 8px;
                }
                .markdown-content p {
                    margin-bottom: 8px;
                }
                .markdown-content ul, .markdown-content ol {
                    padding-left: 20px;
                }
                .markdown-content code {
                    background-color: var(--vscode-textCodeBlock-background);
                    padding: 2px 4px;
                    border-radius: 3px;
                    font-family: 'Courier New', monospace;
                }
                .markdown-content pre {
                    background-color: var(--vscode-textCodeBlock-background);
                    padding: 8px;
                    border-radius: 3px;
                    overflow: auto;
                }
                .markdown-content pre code {
                    background-color: transparent;
                    padding: 0;
                }
                .markdown-content blockquote {
                    border-left: 3px solid var(--vscode-textLink-foreground);
                    padding-left: 8px;
                    margin-left: 0;
                    color: var(--vscode-descriptionForeground);
                }
            </style>
        </head>
        <body>
            <div class="container">
                <h1>代码漏洞分析</h1>
                
                <div class="controls-top">
                    <button id="configBtn" class="config-btn">配置API密钥</button>
                </div>
                
                <div class="input-section">
                    <textarea id="codeInput" placeholder="在此粘贴或输入要分析的代码..."></textarea>
                    
                    <div class="controls">
                        <button id="analyzeBtn">分析代码</button>
                        <div class="mode-toggle">
                            <input type="checkbox" id="exampleModeToggle" ${isExampleMode ? 'checked' : ''}>
                            <label for="exampleModeToggle">使用示例模式</label>
                        </div>
                    </div>
                </div>
                
                <div id="message" class="message"></div>
                
                <div id="loading" class="loading">
                    <div class="spinner"></div>
                    <div>正在分析代码，请稍候...</div>
                </div>
                
                <div class="output-container">
                    <div class="output-tabs">
                        <div id="auditTab" class="tab active">审计要点</div>
                        <div id="translationTab" class="tab">审计知识</div>
                    </div>
                    
                    <div id="auditSection" class="output-section active">
                        <div id="outputContent" class="output-content markdown-content"></div>
                    </div>
                    
                    <div id="translationSection" class="output-section">
                        <div id="translationContent" class="translation-content markdown-content"></div>
                    </div>
                </div>
            </div>
            
            <script>
                const vscode = acquireVsCodeApi();
                const codeInput = document.getElementById('codeInput');
                const analyzeBtn = document.getElementById('analyzeBtn');
                const configBtn = document.getElementById('configBtn');
                const exampleModeToggle = document.getElementById('exampleModeToggle');
                const outputContent = document.getElementById('outputContent');
                const translationContent = document.getElementById('translationContent');
                const loading = document.getElementById('loading');
                const messageElement = document.getElementById('message');
                const auditTab = document.getElementById('auditTab');
                const translationTab = document.getElementById('translationTab');
                const auditSection = document.getElementById('auditSection');
                const translationSection = document.getElementById('translationSection');
                
                // 初始状态
                let isAnalyzing = false;
                
                // 分析按钮点击事件
                analyzeBtn.addEventListener('click', () => {
                    const code = codeInput.value.trim();
                    if (!code) {
                        showMessage('请输入要分析的代码');
                        return;
                    }
                    
                    vscode.postMessage({
                        command: 'analyze',
                        code: code,
                        language: detectLanguage(code)
                    });
                });
                
                // 示例模式切换
                exampleModeToggle.addEventListener('change', () => {
                    vscode.postMessage({
                        command: 'toggleExampleMode',
                        useExample: exampleModeToggle.checked
                    });
                });
                
                // 标签页切换
                auditTab.addEventListener('click', () => {
                    auditTab.classList.add('active');
                    translationTab.classList.remove('active');
                    auditSection.classList.add('active');
                    translationSection.classList.remove('active');
                });
                
                translationTab.addEventListener('click', () => {
                    translationTab.classList.add('active');
                    auditTab.classList.remove('active');
                    translationSection.classList.add('active');
                    auditSection.classList.remove('active');
                });
                
                // 配置按钮点击事件
                configBtn.addEventListener('click', () => {
                    vscode.postMessage({
                        command: 'openConfig'
                    });
                });
                
                // 接收来自扩展的消息
                window.addEventListener('message', event => {
                    const message = event.data;
                    
                    switch (message.command) {
                        case 'startAnalysis':
                            isAnalyzing = true;
                            loading.style.display = 'block';
                            outputContent.innerHTML = '';
                            translationContent.innerHTML = '';
                            analyzeBtn.disabled = true;
                            break;
                            
                        case 'analysisResult':
                            isAnalyzing = false;
                            loading.style.display = 'none';
                            analyzeBtn.disabled = false;
                            displayResults(message.results);
                            break;
                            
                        case 'translationResult':
                            translationContent.innerHTML = formatText(message.translatedText);
                            // 如果有翻译结果，显示提示
                            if (message.translatedText) {
                                showMessage('审计知识整理已完成，可点击"审计知识"标签查看');
                            }
                            break;
                            
                        case 'analysisError':
                            isAnalyzing = false;
                            loading.style.display = 'none';
                            analyzeBtn.disabled = false;
                            outputContent.innerHTML = \`<div class="error">\${message.error}</div>\`;
                            break;
                            
                        case 'showMessage':
                            showMessage(message.message);
                            break;
                            
                        case 'setCode':
                            codeInput.value = message.code;
                            break;
                        
                        case 'configUpdated':
                            showMessage('API配置已更新');
                            break;
                    }
                });
                
                // 显示消息
                function showMessage(text) {
                    messageElement.textContent = text;
                    messageElement.style.display = 'block';
                    
                    setTimeout(() => {
                        messageElement.style.display = 'none';
                    }, 3000);
                }
                
                // 显示分析结果
                function displayResults(results) {
                    outputContent.innerHTML = '';
                    
                    if (!results || results.length === 0) {
                        outputContent.innerHTML = '<div>未发现漏洞</div>';
                        return;
                    }
                    
                    // 检查是否是增强后的结果格式（只有审计要点）
                    if (results.length === 1 && results[0].auditPoints) {
                        const auditPointsHtml = \`
                            <div class="vulnerability-item">
                                <div class="vulnerability-title">代码审计要点</div>
                                <div class="audit-points">\${formatText(results[0].auditPoints)}</div>
                            </div>
                        \`;
                        outputContent.innerHTML = auditPointsHtml;
                        return;
                    }
                    
                    // 显示常规漏洞结果
                    results.forEach(vuln => {
                        const severityClass = getSeverityClass(vuln.severity);
                        
                        // 将描述和建议作为Markdown渲染
                        const vulnHtml = \`
                            <div class="vulnerability-item">
                                <div class="vulnerability-title \${severityClass}">\${vuln.title}</div>
                                <div><strong>严重性:</strong> <span class="\${severityClass}">\${formatSeverity(vuln.severity)}</span></div>
                                <div><strong>类别:</strong> \${vuln.category || '未分类'}</div>
                                <div><strong>描述:</strong> <div>\${formatText(vuln.description)}</div></div>
                                <div><strong>建议:</strong> <div>\${formatText(vuln.recommendation)}</div></div>
                                \${vuln.codeExample ? \`<div><strong>示例代码:</strong><pre><code>\${vuln.codeExample}</code></pre></div>\` : ''}
                                <div><strong>相似度:</strong> \${(vuln.similarityScore * 100).toFixed(2)}%</div>
                            </div>
                        \`;
                        
                        outputContent.innerHTML += vulnHtml;
                    });
                }
                
                // 格式化文本，保留换行
                function formatText(text) {
                    if (!text) return '';
                    // 使用marked.js渲染Markdown
                    return marked.parse(text);
                }
                
                // 获取严重性对应的CSS类
                function getSeverityClass(severity) {
                    switch(severity.toLowerCase()) {
                        case 'high': return 'severity-high';
                        case 'medium': return 'severity-medium';
                        case 'low': return 'severity-low';
                        default: return '';
                    }
                }
                
                // 格式化严重性显示
                function formatSeverity(severity) {
                    switch(severity.toLowerCase()) {
                        case 'high': return '高';
                        case 'medium': return '中';
                        case 'low': return '低';
                        default: return severity;
                    }
                }

                // 简单的语言检测函数
                function detectLanguage(code) {
                    // 默认为javascript
                    let language = 'javascript';
                    
                    // 简单的语言检测逻辑
                    if (code.includes('function') && code.includes('{')) {
                        if (code.includes('contract') || code.includes('pragma solidity')) {
                            language = 'solidity';
                        } else if (code.includes('import java.') || code.includes('public class')) {
                            language = 'java';
                        } else if (code.includes('def ') && code.includes(':')) {
                            language = 'python';
                        } else if (code.includes('using namespace') || code.includes('#include')) {
                            language = 'cpp';
                        } else if (code.includes('func ') && code.includes('package ')) {
                            language = 'go';
                        }
                    }
                    
                    return language;
                }
            </script>
        </body>
        </html>`;
    }

    public setCodeAndAnalyze(code: string): void {
        // 发送代码到webview
        this._panel.webview.postMessage({
            command: 'setCode',
            code: code
        });
        
        // 延迟一点时间后自动触发分析
        setTimeout(() => {
            this.analyzeCode(code, this.detectLanguage(code));
        }, 500);
    }

    private detectLanguage(code: string): string {
        // 默认为javascript
        let language = 'javascript';
        
        // 简单的语言检测逻辑
        if (code.includes('function') && code.includes('{')) {
            if (code.includes('contract') || code.includes('pragma solidity')) {
                language = 'solidity';
            } else if (code.includes('import java.') || code.includes('public class')) {
                language = 'java';
            } else if (code.includes('def ') && code.includes(':')) {
                language = 'python';
            } else if (code.includes('using namespace') || code.includes('#include')) {
                language = 'cpp';
            } else if (code.includes('func ') && code.includes('package ')) {
                language = 'go';
            }
        }
        
        return language;
    }
} 